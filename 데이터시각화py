# === Phase 3: ì „ì²˜ë¦¬ëœ ë°ì´í„° ì‹œê°í™” ===
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.font_manager as fm
import platform

INPUT_FILE = 'apartment_rent_processed.csv'

# ================================
# ğŸ”¥ í•œê¸€ í°íŠ¸ ê¹¨ì§ ë°©ì§€ (Windows / Mac / Linux ìë™ ì§€ì›)
# ================================
system = platform.system()

if system == 'Windows':
    plt.rc('font', family='Malgun Gothic')  # ìœˆë„ìš° ê¸°ë³¸ í°íŠ¸
elif system == 'Darwin':  # macOS
    plt.rc('font', family='AppleGothic')
else:  # Linux (Colab ë“±)
    plt.rc('font', family='NanumGothic')

plt.rcParams['axes.unicode_minus'] = False  # ë§ˆì´ë„ˆìŠ¤ ê¸°í˜¸ ê¹¨ì§ ë°©ì§€

# ================================


def load_data():
    print(f"'{INPUT_FILE}' íŒŒì¼ ë¡œë“œ ì¤‘...")
    df = pd.read_csv(INPUT_FILE, encoding='utf-8', parse_dates=['ê³„ì•½ì¼ì'])
    print(f"ë¡œë“œ ì™„ë£Œ. (ì´ {len(df)}ê±´)")
    return df


def plot_distribution(df):
    plt.figure(figsize=(10,5))
    sns.countplot(data=df, x='ì „ì›”ì„¸êµ¬ë¶„')
    plt.title("ì „ì„¸ / ì›”ì„¸ ë°ì´í„° ë¹„ìœ¨")
    plt.show()


def plot_deposit_rent_distribution(df):
    plt.figure(figsize=(10,5))
    sns.histplot(df['ë³´ì¦ê¸ˆ(ë§Œì›)'], bins=50)
    plt.title("ë³´ì¦ê¸ˆ(ë§Œì›) ë¶„í¬")
    plt.show()

    plt.figure(figsize=(10,5))
    sns.histplot(df[df['ì›”ì„¸(ë§Œì›)'] > 0]['ì›”ì„¸(ë§Œì›)'], bins=50)
    plt.title("ì›”ì„¸(ë§Œì›) ë¶„í¬")
    plt.show()


def plot_area_price_relation(df):
    plt.figure(figsize=(10,6))
    sns.scatterplot(data=df, x='ì „ìš©ë©´ì (ã¡)', y='ë³´ì¦ê¸ˆ(ë§Œì›)', hue='ì „ì›”ì„¸êµ¬ë¶„')
    plt.title("ì „ìš©ë©´ì ê³¼ ë³´ì¦ê¸ˆì˜ ê´€ê³„")
    plt.show()


def plot_floor_price(df):
    plt.figure(figsize=(10,6))
    sns.boxplot(data=df, x='ì¸µ', y='ë³´ì¦ê¸ˆ(ë§Œì›)')
    plt.title("ì¸µìˆ˜ë³„ ë³´ì¦ê¸ˆ ë¶„í¬")
    plt.show()


def plot_age_relation(df):
    plt.figure(figsize=(10,6))
    sns.scatterplot(data=df, x='ì•„íŒŒíŠ¸ì—°ì‹', y='ë³´ì¦ê¸ˆ(ë§Œì›)', alpha=0.6)
    plt.title("ì•„íŒŒíŠ¸ ì—°ì‹ê³¼ ë³´ì¦ê¸ˆ ê´€ê³„")
    plt.show()


def plot_region_avg(df):
    plt.figure(figsize=(12,6))
    region_mean = df.groupby('ë²•ì •ë™')[['ë³´ì¦ê¸ˆ(ë§Œì›)','ì›”ì„¸(ë§Œì›)']].mean().sort_values('ë³´ì¦ê¸ˆ(ë§Œì›)', ascending=False).head(15)
    region_mean.plot(kind='bar', figsize=(12,6))
    plt.title("ì§€ì—­ë³„ í‰ê·  ë³´ì¦ê¸ˆ/ì›”ì„¸ (Top 15)")
    plt.xticks(rotation=45)
    plt.show()


def plot_time_series(df):
    monthly = df.resample('M', on='ê³„ì•½ì¼ì')['ë³´ì¦ê¸ˆ(ë§Œì›)'].mean()
    plt.figure(figsize=(12,6))
    plt.plot(monthly.index, monthly.values)
    plt.title("ì›”ë³„ í‰ê·  ë³´ì¦ê¸ˆ ë³€í™”")
    plt.xlabel("ë‚ ì§œ")
    plt.ylabel("ë³´ì¦ê¸ˆ(ë§Œì›)")
    plt.grid(True)
    plt.show()


def plot_outliers(df):
    plt.figure(figsize=(10,5))
    sns.boxplot(data=df, y='ë³´ì¦ê¸ˆ(ë§Œì›)')
    plt.title("ë³´ì¦ê¸ˆ ì´ìƒì¹˜(Boxplot)")
    plt.show()


def visualize_all():
    df = load_data()

    print("\n[1] ì „ì›”ì„¸ ë¹„ìœ¨ ì‹œê°í™”")
    plot_distribution(df)

    print("\n[2] ë³´ì¦ê¸ˆ / ì›”ì„¸ ë¶„í¬")
    plot_deposit_rent_distribution(df)

    print("\n[3] ì „ìš©ë©´ì â€“ë³´ì¦ê¸ˆ ê´€ê³„")
    plot_area_price_relation(df)

    print("\n[4] ì¸µìˆ˜ë³„ ë³´ì¦ê¸ˆ ë°•ìŠ¤í”Œë¡¯")
    plot_floor_price(df)

    print("\n[5] ì•„íŒŒíŠ¸ ì—°ì‹ê³¼ ë³´ì¦ê¸ˆ ê´€ê³„")
    plot_age_relation(df)

    print("\n[6] ì§€ì—­ë³„ í‰ê·  ë³´ì¦ê¸ˆ/ì›”ì„¸")
    plot_region_avg(df)

    print("\n[7] ê³„ì•½ì¼ì ê¸°ë°˜ ì‹œê³„ì—´ ë¶„ì„")
    plot_time_series(df)

    print("\n[8] ë³´ì¦ê¸ˆ ì´ìƒì¹˜ ë¶„ì„")
    plot_outliers(df)



if __name__ == "__main__":
    visualize_all()